{% extends "layout.html" %}

{% block content %}
<!-- Header Section -->
<div class="hero-header animate-fade-in">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; position: relative; z-index: 1;">
        <div>
            <h1 style="font-size: 2.8rem; font-weight: 800; margin-bottom: 0.75rem; letter-spacing: -1.5px;">
                Admin <span class="text-gradient">Command Hub</span>
            </h1>
            <p style="color: var(--text-dim); font-size: 1.1rem; max-width: 600px;">Orchestrate your virtual campus.
                Manage classrooms, monitor submissions, and empower your students from one central dashboard.</p>
        </div>
        <div style="text-align: right;">
            <a href="{{ url_for('post_question') }}" class="btn btn-primary"
                style="padding: 1rem 2rem; font-size: 1rem;">
                <svg style="width:24px; height:24px" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                </svg>
                Post New Challenge
            </a>
        </div>
    </div>
</div>

<!-- Notification Settings Quick-Fix -->
<div id="notif-setup-box" class="glass-panel"
    style="display: none; padding: 1rem 2rem; margin-bottom: 2.5rem; background: rgba(99, 102, 241, 0.05); border: 1px solid var(--primary); border-radius: 1rem; align-items: center; justify-content: space-between; gap: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <div
            style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary);">
            <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.09,8.58L17.5,10L11,16.5Z" />
            </svg>
        </div>
        <div>
            <h3 style="font-size: 1rem; font-weight: 700;">Desktop Notifications</h3>
            <p style="font-size: 0.85rem; color: var(--text-dim);">Enable alerts to monitor student activity even when
                working in other tabs.</p>
        </div>
    </div>
    <button onclick="requestNotifPermission()" class="btn btn-primary"
        style="padding: 0.6rem 1.25rem; font-size: 0.8rem; white-space: nowrap;">
        Enable Alerts
    </button>
</div>

<script>
    if ("Notification" in window && Notification.permission !== "granted") {
        document.getElementById('notif-setup-box').style.display = 'flex';
    }

    function requestNotifPermission() {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                document.getElementById('notif-setup-box').style.display = 'none';
                new Notification("Success!", { body: "Desktop notifications are now active.", icon: "/static/favicon.ico" });
            }
        });
    }
</script>



<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 12px;">
        <div
            style="width: 48px; height: 48px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
            <svg style="width:28px; height:28px" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5Z" />
            </svg>
        </div>
        <h2 style="font-size: 1.8rem; font-weight: 800; margin: 0;">Admin Control Center</h2>
    </div>
    <a href="{{ url_for('admin_stats') }}" class="btn btn-primary"
        style="display: flex; align-items: center; gap: 8px; padding: 0.75rem 1.5rem;">
        <svg style="width:20px; height:20px" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M16,11.78L20.24,7.54L21.66,8.96L16,14.62L13.17,11.79L9.87,15.09L8.45,13.67L13.17,8.95L16,11.78M2,19H22V21H2V19Z" />
        </svg>
        View Platform Analytics
    </a>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; align-items: start; margin-bottom: 3.5rem;">
    <div style="display: grid; gap: 2.5rem;">
        <!-- Classroom Management Section -->
        <div class="card" style="border-left: 5px solid var(--accent); position: relative; margin-bottom: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; margin: 0;">Live Classroom</h2>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    {% if classroom and classroom.is_live %}
                    <div
                        style="background: rgba(16, 185, 129, 0.1); color: var(--accent); padding: 0.4rem 1rem; border-radius: 2rem; font-weight: 700; font-size: 0.75rem; display: flex; align-items: center; gap: 6px;">
                        <div class="live-indicator"
                            style="background: var(--accent); box-shadow: 0 0 10px var(--accent);"></div>
                        LIVE
                    </div>
                    {% else %}
                    <div
                        style="background: rgba(255, 255, 255, 0.05); color: var(--text-dim); padding: 0.4rem 1rem; border-radius: 2rem; font-weight: 700; font-size: 0.75rem;">
                        OFFLINE
                    </div>
                    {% endif %}
                </div>
            </div>

            <form action="{{ url_for('update_classroom') }}" method="POST" style="display: grid; gap: 1.25rem;">
                <div>
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.85rem; font-weight: 600;">Main
                        Meeting URL</label>
                    <input type="url" name="meet_link" value="{{ classroom.active_meet_link if classroom else '' }}"
                        placeholder="https://meet.google.com/..." style="padding: 0.75rem 1rem;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                    <label class="toggle-container"
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="is_live" {% if classroom and classroom.is_live %}checked{% endif %}
                            style="width: 18px; height: 18px; accent-color: var(--primary);">
                        <span>Set Status as Live</span>
                    </label>
                    <button type="submit" class="btn btn-primary"
                        style="padding: 0.6rem 1.2rem; font-size: 0.85rem;">Update</button>
                </div>
            </form>
        </div>


    </div>

    <div style="display: grid; gap: 2.5rem;">
        <!-- Meet Link Library -->
        <div class="card" style="border-left: 5px solid #8b5cf6; margin-bottom: 0;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 700; margin: 0;">Meeting Library</h2>
            </div>

            <form action="{{ url_for('add_meet_link') }}" method="POST"
                style="display: grid; grid-template-columns: 1fr 1.5fr auto; gap: 0.75rem; margin-bottom: 1.5rem; align-items: end;">
                <div>
                    <label
                        style="display: block; margin-bottom: 0.4rem; color: var(--text-dim); font-size: 0.75rem; font-weight: 700;">Label</label>
                    <input type="text" name="label" required placeholder="Session"
                        style="padding: 0.6rem 0.8rem; font-size: 0.85rem;">
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 0.4rem; color: var(--text-dim); font-size: 0.75rem; font-weight: 700;">URL</label>
                    <input type="url" name="url" required placeholder="https://..."
                        style="padding: 0.6rem 0.8rem; font-size: 0.85rem;">
                </div>
                <button type="submit" class="btn btn-primary"
                    style="height: 38px; padding: 0 0.8rem; font-size: 0.85rem;">Add</button>
            </form>

            <div style="display: grid; gap: 0.75rem; max-height: 250px; overflow-y: auto; padding-right: 5px;">
                {% for link in meet_links %}
                <div class="glass-panel"
                    style="padding: 1rem; background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; border-radius: 12px;">
                    <div style="max-width: 65%;">
                        <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 2px;">
                            {{ link.label }}</div>
                        <div style="color: var(--primary); font-size: 0.75rem; word-break: break-all; opacity: 0.8;">{{
                            link.url[:40] }}...</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <form action="{{ url_for('toggle_meet_link', link_id=link.id) }}" method="POST">
                            <button type="submit" class="btn-status {{ 'active' if link.is_active else 'paused' }}"
                                style="padding: 0.3rem 0.6rem; font-size: 0.65rem; border-radius: 6px; border: none; font-weight: 800; cursor: pointer;">
                                {{ 'ON' if link.is_active else 'OFF' }}
                            </button>
                        </form>
                        <form action="{{ url_for('delete_meet_link', link_id=link.id) }}" method="POST"
                            onsubmit="return confirm('Delete?')">
                            <button type="submit"
                                style="background: rgba(239, 68, 68, 0.1); color: var(--danger); border: none; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.65rem; font-weight: 800; cursor: pointer;">Del</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>



<!-- Dashboards Quick Access (Moved to Downside) -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
    <a href="{{ url_for('admin_questions_dashboard') }}" class="card glass-panel"
        style="text-decoration: none; display: flex; align-items: center; gap: 1.25rem; padding: 1.25rem 1.5rem; border-top: 4px solid var(--primary); transition: transform 0.3s ease; margin-bottom: 0;">
        <div
            style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
            <svg style="width:20px; height:20px" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,13H13V15H11V13M11,7H13V11H11V7Z" />
            </svg>
        </div>
        <div>
            <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-main);">Active Questions</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">{{ questions|length }} Total Challenges</div>
        </div>
    </a>

    <a href="{{ url_for('admin_submissions_dashboard') }}" class="card glass-panel"
        style="text-decoration: none; display: flex; align-items: center; gap: 1.25rem; padding: 1.25rem 1.5rem; border-top: 4px solid var(--accent); transition: transform 0.3s ease; margin-bottom: 0;">
        <div
            style="width: 40px; height: 40px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--accent);">
            <svg style="width:20px; height:20px" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M14,10H19.5L14,4.5V10M5,3H15L21,9V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3M5,5V19H19V12H12V5H5Z" />
            </svg>
        </div>
        <div>
            <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-main);">Latest Submissions</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">Student Solutions</div>
        </div>
    </a>

    <a href="{{ url_for('admin_members_dashboard') }}" class="card glass-panel"
        style="text-decoration: none; display: flex; align-items: center; gap: 1.25rem; padding: 1.25rem 1.5rem; border-top: 4px solid var(--secondary); transition: transform 0.3s ease; margin-bottom: 0;">
        <div
            style="width: 40px; height: 40px; background: rgba(139, 92, 246, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--secondary);">
            <svg style="width:20px; height:20px" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M16,13C15.71,13 15.38,13 15.03,13.05C16.19,13.89 17,15 17,16.5V19H23V16.5C23,14.17 18.33,13 16,13M8,13C5.67,13 1,14.17 1,16.5V19H15V16.5C15,14.17 10.33,13 8,13M8,11A3,3 0 0,0 11,8A3,3 0 0,0 8,5A3,3 0 0,0 5,8A3,3 0 0,0 8,11M16,11A3,3 0 0,0 19,8A3,3 0 0,0 16,5A3,3 0 0,0 13,8A3,3 0 0,0 16,11Z" />
            </svg>
        </div>
        <div>
            <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-main);">Student Profiles</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">{{ all_users|length }} Registered</div>
        </div>
    </a>

    <a href="{{ url_for('admin_stats') }}" class="card glass-panel"
        style="text-decoration: none; display: flex; align-items: center; gap: 1.25rem; padding: 1.25rem 1.5rem; border-top: 4px solid #f59e0b; transition: transform 0.3s ease; margin-bottom: 0;">
        <div
            style="width: 40px; height: 40px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #f59e0b;">
            <svg style="width:20px; height:20px" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M16,11.78L20.24,7.54L21.66,8.96L16,14.62L13.17,11.79L9.87,15.09L8.45,13.67L13.17,8.95L16,11.78M2,19H22V21H2V19Z" />
            </svg>
        </div>
        <div>
            <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-main);">Platform Analytics</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">Historical Performance</div>
        </div>
    </a>
</div>

<!-- Recent Activity Section -->
<div class="card glass-panel" style="padding: 2.5rem; margin-top: 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div
                style="width: 40px; height: 40px; background: rgba(139, 92, 246, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--secondary);">
                <svg style="width:24px; height:24px" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M14,10H19.5L14,4.5V10M5,3H15L21,9V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3M5,5V19H19V12H12V5H5Z" />
                </svg>
            </div>
            <h2 style="font-size: 1.5rem; font-weight: 700;">Recent Submissions</h2>
        </div>
        <a href="{{ url_for('admin_submissions_dashboard') }}" class="btn"
            style="color: var(--primary); font-weight: 700; font-size: 0.9rem;">View All Records â†’</a>
    </div>

    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                    <th style="padding: 1rem;">Student</th>
                    <th style="padding: 1rem;">Challenge</th>
                    <th style="padding: 1rem;">Status</th>
                    <th style="padding: 1rem; text-align: right;">Time</th>
                </tr>
            </thead>
            <tbody>
                {% for r in results[:5] %}
                <tr style="border-top: 1px solid var(--glass-border);">
                    <td style="padding: 1.25rem 1rem;">
                        <a href="{{ url_for('admin_view_user', user_id=r.student_id) }}"
                            style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
                            <div
                                style="width: 28px; height: 28px; border-radius: 50%; overflow: hidden; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1);">
                                {% if r.profile_image %}
                                <img src="{{ url_for('serve_profile_pic', user_id=r.student_id, filename=r.profile_image) }}"
                                    style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                <svg style="width: 14px; height: 14px; color: var(--text-dim);" viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                        d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                                </svg>
                                {% endif %}
                            </div>
                            <span style="font-weight: 700; color: var(--text-main); transition: color 0.1s;"
                                onmouseover="this.style.color='var(--primary)'"
                                onmouseout="this.style.color='var(--text-main)'">
                                {{ r.student_name }}
                            </span>
                        </a>
                    </td>
                    <td style="padding: 1.25rem 1rem; color: var(--text-dim); font-size: 0.9rem;">
                        {{ r.question.text[:40] }}{{ '...' if r.question.text|length > 40 }}
                    </td>
                    <td style="padding: 1.25rem 1rem;">
                        <span
                            style="font-size: 0.7rem; font-weight: 800; padding: 4px 10px; border-radius: 20px; {{ 'background: rgba(16,185,129,0.1); color: var(--accent);' if r.is_correct else 'background: rgba(239,68,68,0.1); color: var(--danger);' }}">
                            {{ 'PASS' if r.is_correct else 'FAIL' }}
                        </span>
                    </td>
                    <td style="padding: 1.25rem 1rem; text-align: right; color: var(--text-dim); font-size: 0.8rem;">
                        {{ r.submitted_at.strftime('%H:%M') }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if not results %}
    <div style="padding: 3rem; text-align: center; color: var(--text-dim);">No recent activity detected.</div>
    {% endif %}
</div>

<!-- Global System Activity -->
<div class="card glass-panel" style="padding: 2.5rem; margin-top: 2.5rem; border-top: 4px solid var(--secondary);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div
                style="width: 40px; height: 40px; background: rgba(139, 92, 246, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--secondary);">
                <svg style="width:24px; height:24px" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z" />
                </svg>
            </div>
            <h2 style="font-size: 1.5rem; font-weight: 700;">Global System Activity</h2>
        </div>
        <a href="{{ url_for('admin_activity_logs') }}" class="btn btn-primary"
            style="padding: 0.5rem 1.25rem; font-size: 0.85rem;">
            View Full Log
            <svg style="width:18px;height:18px" viewBox="0 0 24 24">
                <path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" />
            </svg>
        </a>
    </div>

    <div style="display: grid; gap: 1rem;">
        {% if activity_logs %}
        {% for log in activity_logs %}
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.2s ease;"
            onmouseover="this.style.transform='translateX(5px)'; this.style.borderColor='var(--secondary)'"
            onmouseout="this.style.transform='translateX(0)'; this.style.borderColor='rgba(255,255,255,0.05)'">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="font-weight: 800; font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; 
                        {% if log.action == 'REGISTER' %}background: rgba(16,185,129,0.1); color: var(--accent);
                        {% elif log.action == 'LOGIN' %}background: rgba(99,102,241,0.1); color: var(--primary);
                        {% else %}background: rgba(255,255,255,0.05); color: var(--text-dim);{% endif %}">
                    {{ log.action }}
                </div>
                <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-main);">
                    {{ log.details }}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.8rem; color: var(--text-dim); font-weight: 500;">
                    {{ log.event_time.strftime('%Y-%m-%d | %H:%M') }}
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div
            style="padding: 3rem; text-align: center; color: var(--text-dim); background: rgba(255,255,255,0.02); border-radius: 12px;">
            No system events recorded yet.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .btn-status {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
    }

    .btn-status.active {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent);
    }

    .btn-status.paused {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-dim);
    }
</style>
{% endblock %}