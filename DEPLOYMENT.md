# ğŸ›¡ï¸ AptitudePro â€” Deployment & Database Safety Guide

## âš ï¸ #1 Rule: Database Safety

> **Code updates via VS Code and GitHub NEVER delete, reset, or overwrite database data.**
>
> This is enforced through: additive-only migrations, `.gitignore` exclusions, and
> `db.create_all()` (which only creates missing tables â€” never drops or modifies existing ones).

---

## ğŸ—„ï¸ Database Architecture

| Environment | Engine | Location | Git-tracked? |
|---|---|---|---|
| Local Dev | SQLite | `instance/aptipro.db` | âŒ No (`.gitignore`) |
| Production | PostgreSQL | Render managed DB | âŒ No (external service) |

### Why data is always safe:
1. `.gitignore` includes `*.db` and `instance/` â€” database files **never enter Git**
2. `db.create_all()` only **adds** new tables, never drops existing ones
3. `safe_alter()` â€” only **adds** new columns; if a column already exists, the error is silently ignored
4. **No `db.drop_all()`, `TRUNCATE`, or `DROP TABLE` anywhere in the codebase**
5. Seeding code uses `if not X.query.first():` guards â€” only seeds on first run, never overwrites

---

## ğŸ“‹ Safe Deployment Steps (Every Time)

### 1. Backup the database (locally)
```bash
python backup_db.py
```
Creates a timestamped backup in `backups/`. Verify it was created.

### 2. Commit only code (NOT database)
```bash
git status       # Verify instance/ and *.db are NOT listed
git add .
git commit -m "Update: describe your change here"
git push origin main
```

### 3. Monitor Render logs after deploy
Look for this line in Render logs â†’ confirms safe migration ran:
```
[DB] âœ… Initialization complete. All existing data preserved.
```

---

## ğŸŒ Render.com Configuration

### render.yaml (already configured)
```yaml
services:
  - type: web
    name: aptipro
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn app:app
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: aptipro-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
```

### Required Environment Variables (set in Render Dashboard)
| Variable | Required | Description |
|---|---|---|
| `DATABASE_URL` | âœ… Yes | Auto-set from linked Render PostgreSQL DB |
| `SECRET_KEY` | âœ… Yes | Auto-generated by Render |
| `INITIALIZE_DB` | Optional | Default `true` â€” safe to leave on |

---

## ğŸ”§ How Safe Migrations Work

On every app startup, `init_db()` in `app.py`:

```python
db.create_all()           # Creates missing tables ONLY â€” never touches existing ones

safe_alter("ALTER TABLE answer ADD COLUMN is_expired BOOLEAN DEFAULT FALSE")
# â†’ If column exists: DB raises error â†’ silently ignored âœ…
# â†’ If column missing: column is added âœ…
# â†’ Existing rows: untouched, get DEFAULT value âœ…
```

This makes every deploy **fully idempotent** â€” safe to run 100 times on the same database.

---

## ğŸ†˜ Emergency Restore (Local)

```bash
# Stop the app, then:
copy backups\aptipro_YYYYMMDD_HHMMSS.db instance\aptipro.db
python app.py
```

For production PostgreSQL, use Render Dashboard â†’ Your DB â†’ Backups.

---

## ğŸ” Security Checklist

- [ ] `SECRET_KEY` set to a random string in Render environment
- [ ] Default admin password changed after first login
- [ ] `DATABASE_URL` pointing to Render PostgreSQL (not SQLite) in production
- [ ] `.env` file is in `.gitignore` (never committed)

---

## ğŸ“± Local Development

```bash
# Run locally:
python app.py

# Back up database before any code changes:
python backup_db.py
```

Access: `http://localhost:5000` or `http://YOUR_LOCAL_IP:5000`

---

## ğŸ¯ Default Credentials (First-Run Only)

- **Admin**: `admin` / `admin123`
- âš ï¸ Change this immediately after first login!
- Students register via the registration page
